

# 一 回流(Reflow)在浏览器渲染过程中的含义,并解释何时会触发回流?

## 1.1 什么是回流(Reflow)?

> 回流（Reflow），有时也称为布局重排（Layout Reflow）或重排，是浏览器渲染引擎中的一个关键概念，指的是当网页的一部分或全部需要根据新的渲染规则重新计算其几何属性（如位置和大小）并更新渲染树的过程。简而言之，当页面的布局需要改变时，浏览器就需要执行回流来确定每个元素的精确位置和大小。

## 1.2 触发回流的方式

触发回流的情况主要包括但不限于以下几种：

1. **DOM结构调整**：添加或删除可见的DOM元素，或者修改DOM元素的位置，如通过JavaScript操作DOM。
2. **元素尺寸改变**：修改元素的宽度、高度、内外边距、边框宽度等属性，导致元素所占空间变化。
3. **浏览器窗口尺寸变化**：用户调整浏览器窗口大小，使得页面布局需要适应新的视口尺寸。
4. **字体大小调整**：页面中字体大小的动态改变会影响到元素的尺寸和位置，从而触发回流。
5. **CSS样式更改**：应用新的CSS样式规则，尤其是那些影响布局的属性（如`display`、`float`、`position`）。
6. **计算某些特定样式值**：当使用JavaScript或CSSOM（CSS Object Model）查询某些特定的样式值（如offsetWidth、offsetHeight等），浏览器可能需要提前完成布局计算以提供准确的值，这会触发回流。

## 1.3 如何减少回流

1. **批量修改样式**：尽量一次性修改多个样式属性，而不是逐个修改，因为每次修改都可能触发独立的回流。可以先修改元素的样式，然后一次性应用所有更改。
2. **使用CSS变换代替动画**：利用CSS的`transform`和`opacity`属性进行动画，因为这些变化可以在合成层进行，不会触发回流，只会影响绘制。
3. **避免频繁操作DOM**：减少对DOM的操作频率，特别是在循环或频繁的事件处理程序中。可以考虑使用`DocumentFragment`来构建复杂的DOM结构，然后一次性添加到文档中。
4. **使用`requestAnimationFrame`**：对于需要动画效果的改变，使用`requestAnimationFrame`来安排样式变更和布局操作，这样可以让浏览器在下一次绘制前优化所有更改，可能减少回流次数。
5. **避免强制同步布局读取**：不要在JavaScript中频繁使用如`offsetWidth`、`offsetHeight`、`getComputedStyle()`等方法，因为它们会强制浏览器立即计算布局，可能导致不必要的回流。尽可能缓存这些值或在必要时才读取。
6. **合理设计CSS选择器**：避免使用过于复杂或深度嵌套的选择器，因为它们可能使浏览器在计算样式时做更多的工作。
7. **将动画元素绝对定位或固定定位**：将动画元素移出常规文档流，使用`position: absolute`或`position: fixed`，这样其变化不会影响到其他元素的布局。
8. **避免使用table布局**：表格布局在内容变化时更容易触发回流，因为它们依赖于单元格间的关系。考虑使用更现代的布局方式，如Flexbox或Grid。
9. **监控和诊断**：使用开发者工具中的性能分析器来检测哪些操作导致了回流和重绘，针对性地进行优化。
10. **合理使用CSS布局属性**：如`display: flex`和`display: grid`等现代布局模式，虽然在初始化时可能需要更多计算，但它们可以简化布局逻辑，减少因复杂布局导致的回流。

