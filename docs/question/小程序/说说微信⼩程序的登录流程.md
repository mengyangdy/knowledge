---
title: 说说微信⼩程序的登录流程?
tags:
  - 小程序
  - 面试题
date: 2024-06-12
---

# 一 说说微信⼩程序的登录流程?

## 1.1 背景

传统的 web 开发实现登陆功能，⼀般的做法是输⼊账号密码、或者输⼊⼿机号及短信验证码进⾏登录服务端校验⽤⼾信息通过之后，下发⼀个代表登录态的 token 给客⼾端，以便进⾏后续的交互,每当 token 过期，⽤⼾都需要重新登录

⽽在微信⼩程序中，可以通过微信官⽅提供的登录能⼒⽅便地获取微信提供的⽤⼾⾝份标识，快速建⽴⼩程序内的⽤⼾体系，从⽽实现登陆功能

实现⼩程序⽤⼾体系主要涉及到 openid 和 code 的概念：
- 调⽤ wx.login() ⽅法会⽣成 code ，将 code 作为参数传递给微信服务器指定接⼝，就可以获取⽤⼾的 openid

对于每个⼩程序，微信都会将⽤⼾的微信 ID 映射出⼀个⼩程序 openid ，作为这个⽤⼾在这个⼩程序的唯⼀标识

## 1.2 流程

微信⼩程序登陆具体实现的逻辑如下图所⽰：

![](https://f.pz.al/pzal/2024/06/12/f84b8c00d2946.png)

- 通过 wx.login() 获取到⽤⼾的code判断⽤⼾是否授权读取⽤⼾信息，调⽤wx.getUserInfo 读取⽤⼾数据
- 由于⼩程序后台授权域名⽆法授权微信的域名，所以需要⾃⾝后端调⽤微信服务器获取⽤⼾信息
- 通过 wx.request() ⽅法请求业务⽅服务器，后端把 appid , appsecret 和 code ⼀起发送到微信服务器。 appid 和 appsecret 都是微信提供的，可以在管理员后台找到
- 微信服务器返回了 openid 及本次登录的会话密钥 session_key
- 后端从数据库中查找 openid ，如果没有查到记录，说明该⽤⼾没有注册，如果有记录，则继续往下⾛
- sessionkey 是对⽤⼾数据进⾏加密签名的密钥。为了⾃⾝应⽤安全，session_key 不应该在⽹络上传输
- 然后⽣成 session并返回给⼩程序
- ⼩程序把 session 存到 storage ⾥⾯
- 下次请求时，先从 storage ⾥⾯读取，然后带给服务端
- 服务端对⽐ session 对应的记录，然后校验有效期

更加详细的功能图如下所⽰：

![](https://f.pz.al/pzal/2024/06/12/7995352ab5b6c.png)

## 1.3 扩展

实际业务中，我们还需要登录态是否过期，通常的做法是在登录态（临时令牌）中保存有效期数据，该有效期数据应该在服务端校验登录态时和约定的时间（如服务端本地的系统时间或时间服务器上的标准时间）做对⽐

这种⽅法需要将本地存储的登录态发送到⼩程序的服务端，服务端判断为⽆效登录态时再返回需重新执⾏登录过程的消息给小程序

另⼀种⽅式可以通过调⽤ wx.checkSession 检查微信登陆态是否过期：
- 如果过期，则发起完整的登录流程
- 如果不过期，则继续使⽤本地保存的⾃定义登录态

这种⽅式的好处是不需要⼩程序服务端来参与校验，⽽是在⼩程序端调⽤AP，流程如下所⽰：

![](https://f.pz.al/pzal/2024/06/12/20e42eef5a591.png)