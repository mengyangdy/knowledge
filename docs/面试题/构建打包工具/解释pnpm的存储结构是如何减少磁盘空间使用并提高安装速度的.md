---
title: 解释pnpm的存储结构是如何减少磁盘空间使用并提高安装速度的?
tags:
  - 构建打包工具
  - 面试题
date: 2024-05-29
---
# 一解释pnpm的存储结构是如何减少磁盘空间使用并提高安装速度的?

pnpm（Performant npm）通过一种创新的存储和链接机制来减少磁盘空间使用并提高安装速度，这一机制主要基于以下核心概念：

1. **内容可寻址的存储仓库**： pnpm 使用一个全局的、内容可寻址的存储区域（默认位于 `${os.homedir}/.pnpm-store`），在这个位置存储所有依赖包的每个版本的唯一副本。这意味着对于每个模块的每个版本，无论多少项目使用它，都只会在磁盘上保留一份。
    
2. **硬链接和符号链接**： 当在项目中安装依赖时，pnpm 不直接将依赖复制到项目的 `node_modules` 目录中，而是通过创建硬链接（或在不支持硬链接的系统上使用符号链接）将这些依赖链接至 `.pnpm-store` 中的相应包。硬链接让文件在文件系统中看起来像是独立存在的，但实际上它们共享同一个存储位置的inode（文件系统索引节点），从而不占用额外的磁盘空间。
    
3. **分层的 node_modules 结构**： pnpm 构建了一个分层的 `node_modules` 目录结构，这不仅有助于管理依赖关系，还能确保包之间的隔离性。每个层级的 `node_modules` 目录中只包含直接依赖，间接依赖通过链接指向更高层级的目录，这样的设计减少了重复文件，并且使得依赖解析更加高效。
    
4. **并行安装**： pnpm 利用并行处理能力，在安装依赖时同时下载和安装多个包，这大大缩短了安装时间，尤其是在处理大型项目或依赖树较深的情况下。
    
5. **增量安装与智能缓存**： pnpm 通过比对现有的依赖状态与期望状态，仅安装缺失或更新的依赖，避免了不必要的下载和安装。同时，它利用智能缓存机制，仅在包发生实际变化时才会重新下载，进一步提升效率。
    

综上所述，通过内容可寻址存储、硬链接技术、分层的目录结构、并行处理以及智能的增量更新策略，pnpm 成功地在不牺牲依赖管理准确性的前提下，大幅度减少了磁盘空间的占用，并加快了安装速度。这对于经常处理多项目环境和依赖共享的开发者来说，是非常有益的。

