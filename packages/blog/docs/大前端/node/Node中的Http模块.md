---
title: Nodeä¸­çš„Httpæ¨¡å—
tags:
  - http
  - node
date: 2023-10-15
cover: https://s2.loli.net/2023/10/15/62IfAtcgbrnJ3zV.jpg
---

# Node ä¸­çš„ Http æ¨¡å—

## web æœåŠ¡å™¨

- ä»€ä¹ˆæ˜¯ web æœåŠ¡å™¨ï¼Ÿ
  - å½“åº”ç”¨ç¨‹åºï¼ˆå®¢æˆ·ç«¯ï¼‰éœ€è¦æŸä¸€ä¸ªèµ„æºæ—¶ï¼Œå¯ä»¥å‘ä¸€å°æœåŠ¡å™¨ï¼Œé€šè¿‡ http è¯·æ±‚è·å–åˆ°è¿™ä¸ªèµ„æºï¼Œæä¾›èµ„æºçš„è¿™ä¸ªæœåŠ¡å™¨ï¼Œå°±æ˜¯ web æœåŠ¡å™¨ã€‚

![](https://s2.loli.net/2023/10/15/klUWtye9MZ6zbcH.png)

- ç›®å‰æœ‰å¾ˆå¤šçš„å¼€æºçš„ web æœåŠ¡å™¨ï¼šNginxã€Apacheï¼ˆé™æ€ï¼‰ã€Apche Tomcat (é™æ€ã€åŠ¨æ€)ã€NodeJS

web æœåŠ¡å™¨ä½“éªŒï¼š

```js
const http = require('http')
const HTTP_PORT = 8000
const server = http.createServer((req, res) => {
  res.end('hello world')
})

server.listen(8000, () => {
  console.log(`æœåŠ¡å™¨åœ¨${HTTP_PORT}å¯åŠ¨`)
})
```

## åˆ›å»ºæœåŠ¡å™¨

- åˆ›å»ºæœåŠ¡å™¨å¯¹è±¡ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ createServer æ¥å®Œæˆçš„ï¼š
  - http. createServer ä¼šè¿”å›æœåŠ¡å™¨çš„å¯¹è±¡
  - åº•å±‚å…¶å®ä½¿ç”¨ç›´æ¥ new Server å¯¹è±¡

```js
function createServer(opts, requestListener) {
  return new Server(opts, requestListener)
}
```

- é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±æ¥åˆ›å»ºè¿™ä¸ªå¯¹è±¡ï¼š

```js
const server2 = new http.Server((req, res) => {
  res.end('htello server2')
})
server2.listen(9000, () => {
  console.log(`æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ`)
})
```

- åˆ›å»º Server æ—¶å€™ä¼šä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°åœ¨è¢«è°ƒç”¨æ—¶ä¼šä¼ å…¥ä¸¤ä¸ªå‚æ•°
  - req: request è¯·æ±‚å¯¹è±¡ï¼ŒåŒ…å«è¯·æ±‚ç›¸å…³çš„ä¿¡æ¯
  - resï¼šresponse å“åº”å¯¹è±¡ï¼ŒåŒ…å«æˆ‘ä»¬è¦å‘é€ç»™å®¢æˆ·ç«¯çš„ä¿¡æ¯

### ç›‘å¬ä¸»æœºå’Œç«¯å£å·

- Server é€šè¿‡ listen æ–¹æ³•æ¥å¼€å¯æœåŠ¡å™¨ï¼Œå¹¶ä¸”åœ¨æŸä¸€ä¸ªä¸»æœºå’Œç«¯å£ä¸Šç›‘å¬ç½‘ç»œè¯·æ±‚
  - ä¹Ÿå°±æ˜¯å½“æˆ‘ä»¬é€šè¿‡ ip: port çš„æ–¹å¼å‘é€åˆ°æˆ‘ä»¬ç›‘å¬çš„ web æœåŠ¡å™¨ä¸Šæ—¶
  - æˆ‘ä»¬å°±å¯ä»¥å¯¹å…¶è¿›è¡Œç›¸å…³çš„å¤„ç†
- Listen å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼š
  - ç«¯å£ portï¼šå¯ä»¥ä¸ä¼ ï¼Œç³»ç»Ÿä¼šé»˜è®¤åˆ†é…ï¼Œåç»­é¡¹ç›®ä¸­æˆ‘ä»¬ä¼šå†™å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­
  - ä¸»æœº host: é€šå¸¸å¯ä»¥ä¼ å…¥ localhostã€ip åœ°å€ 127.0.0.1ã€æˆ–è€… ip åœ°å€ 0.0.0.0ï¼Œé»˜è®¤æ˜¯ 0.0.0.0
    - localhost: æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŸŸåï¼Œé€šå¸¸æƒ…å†µä¸‹ä¼šè¢«è§£ææˆ 127.0.0.1
    - 127.0.0.1ï¼šå›ç¯åœ°å€ï¼ˆLoop Back Addressï¼‰, è¡¨è¾¾çš„æ„æ€å…¶å®æ˜¯æˆ‘ä»¬ä¸»æœºè‡ªå·±å‘å‡ºå»é¢åŒ…ï¼Œç›´æ¥è¢«è‡ªå·±æ¥æ”¶
      - æ­£å¸¸çš„æ•°æ®åº“åŒ…ç»å¸¸åº”ç”¨å±‚-ä¼ è¾“å±‚-ç½‘ç»œå±‚-æ•°æ®é“¾è·¯å±‚-ç‰©ç†å±‚
      - è€Œå›ç¯åœ°å€ï¼Œæ˜¯åœ¨ç½‘ç»œå±‚ç›´æ¥å°±è¢«è·å–åˆ°äº†ï¼Œæ˜¯ä¸ä¼šç»å¸¸æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚
      - æ¯”å¦‚æˆ‘ä»¬ç›‘å¬ 127.0.0.1 æ—¶ï¼Œåœ¨åŒä¸€ä¸ªç½‘æ®µä¸‹çš„ä¸»æœºä¸­ï¼Œé€šè¿‡ ip åœ°å€æ˜¯ä¸èƒ½è®¿é—®çš„
    - 0.0.0.0
      - ç›‘å¬ IPV 4 æ‰€æœ‰çš„åœ°å€ï¼Œå†æ ¹æ®ç«¯å£æ‰¾åˆ°ä¸åŒçš„åº”ç”¨ç¨‹åº
      - æ¯”å¦‚è°å“¦ä»¬ç›‘å¬ 0.0.0.0 æ—¶ï¼Œåœ¨åŒä¸€ä¸ªç½‘æ®µä¸‹çš„ä¸»æœºä¸­ï¼Œé€šè¿‡ ip åœ°å€æ˜¯ä¸èƒ½è®¿é—®çš„
  - å›è°ƒå‡½æ•°ï¼ŒæœåŠ¡å™¨å¯åŠ¨æˆåŠŸæ—¶çš„å›è°ƒå‡½æ•°

### request å¯¹è±¡

- åœ¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä¼šæºå¸¦å¾ˆå¤šä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š
  - æœ¬æ¬¡è¯·æ±‚çš„ URLï¼ŒæœåŠ¡å™¨è¦æ ¹æ®ä¸åŒçš„ URL è¿›è¡Œä¸åŒçš„å¤„ç†
  - æœ¬æ¬¡è¯·æ±‚çš„è¯·æ±‚æ–¹å¼ï¼Œæ¯”å¦‚ getã€post è¯·æ±‚ä¼ å…¥çš„å‚æ•°å’Œå¤„ç†çš„æ–¹å¼æ˜¯ä¸åŒçš„
  - æœ¬æ¬¡è¯·æ±‚çš„ headers ä¸­ä¹Ÿä¼šæºå¸¦ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯ä¿¡æ¯ã€æ¥æ”¶æ•°æ®çš„æ ¼å¼ã€æ”¯æŒçš„ç¼–ç æ ¼å¼ç­‰
- è¿™äº›ä¿¡æ¯ï¼Œnode ä¼šå¸®åŠ©æˆ‘ä»¬å°è£…åˆ°ä¸€ä¸ª request çš„å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¥å¤„ç†è¿™ä¸ª request å¯¹è±¡

```js
const server = http.createServer((req, res) => {
  //requestå¯¹è±¡
  console.log(req.url)
  console.log(req.method)
  console.log(req.headers)
  res.end('hello world')
})
```

## URL å¤„ç†

- å®¢æˆ·ç«¯åœ¨å‘é€è¯·æ±‚æ—¶ï¼Œä¼šè¯·æ±‚ä¸åŒçš„æ•°æ®ï¼Œé‚£ä¹ˆä¼šä¼ å…¥ä¸åŒçš„è¯·æ±‚åœ°å€ï¼š
  - æ¯”å¦‚ http://localhost:8000/login
  - æ¯”å¦‚ http://localhost:8000/products
- æœåŠ¡å™¨éœ€è¦æ ¹æ®ä¸åŒçš„è¯·æ±‚åœ°å€ï¼Œåšå‡ºä¸åŒçš„å“åº”

```js
const server=http.createSerer((req,res)=>{
    const url=req.url
    if(url === '/login'){
	    res.end('welcome back')
    }else if(url === /products){
	    res.end('products')
    }else{
        res.end('error')
    }
})
```

### URL çš„è§£æ

- é‚£ä¹ˆå¦‚æœç”¨æˆ·å‘é€çš„åœ°å€ä¸­è¿˜æºå¸¦ä¸€äº›é¢å¤–çš„å‚æ•°å‘¢ï¼Ÿ
  - http://localhost:8000/login?name=dylan
  - è¿™ä¸ªæ—¶å€™ï¼Œurl çš„å€¼æ˜¯/login? name=dylan
- æˆ‘ä»¬å¦‚ä½•å¯¹ä»–è¿›è¡Œè§£æå‘¢ï¼Ÿä½¿ç”¨å†…ç½®çš„æ¨¡å— url

```js
const parseInfo = url.parse(req.url)
console.log(parseInfo)
```

- ä½†æ˜¯ query ä¿¡æ¯å¦‚ä½•è·å–å‘¢ï¼Ÿ

```js
const { name, query } = url.parse(req.url)
const queryObj = qs.parse(query)
console.log(queryObj.name)
```

### method çš„å¤„ç†

- åœ¨ Restful è§„èŒƒï¼ˆè®¾è®¡é£æ ¼ï¼‰ä¸­ï¼Œæˆ‘ä»¬å¯¹äºæ•°æ®çš„å¢åˆ æ”¹æŸ¥åº”è¯¥é€šè¿‡ä¸åŒçš„è¯·æ±‚æ–¹å¼ï¼š
  - GETï¼šæŸ¥è¯¢æ•°æ®
  - POSTï¼šæ–°å»ºæ•°æ®
  - PATCHï¼šæ›´æ–°æ•°æ®
  - DELETEï¼šåˆ é™¤æ•°æ®
- æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­ä¸åŒçš„è¯·æ±‚æ–¹å¼è¿›è¡Œä¸åŒçš„å¤„ç†
  - æ¯”å¦‚åˆ›å»ºä¸€ä¸ªç”¨æˆ·
  - è¯·æ±‚æ¥å£ä¸º/users
  - è¯·æ±‚ä¼šä¸º POST è¯·æ±‚
  - æºå¸¦æ•°æ® name

### åˆ›å»ºç”¨æˆ·æ¥å£

- åœ¨æˆ‘ä»¬ç¨‹åºä¸­å¦‚ä½•è¿›è¡Œåˆ¤æ–­ä»¥åŠè·å–å¯¹åº”çš„æ•°æ®å‘¢ï¼Ÿ
  - è¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­æ¥å£æ˜¯/usersï¼Œå¹¶ä¸”è¯·æ±‚æ–¹å¼æ˜¯ POST æ–¹æ³•å»è·å–ä¼ å…¥çš„æ•°æ®
  - è·å–è¿™ç§ body æºå¸¦çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ç›‘å¬ req çš„ data äº‹ä»¶æ¥è·å–

```js
req.setEncoding('utf-8')
req.on('data', data => {
  const { username, password } = JSON.parse(data)
})
req.on('end', () => {
  console.log('ä¼ è¾“ç»“æŸ')
})
res.end('create user')
```

- å°† JSON å­—ç¬¦ä¸²æ ¼å¼è½¬æˆå¯¹è±¡ç±»å‹ï¼Œé€šè¿‡ JSON. parse æ–¹æ³•å³å¯ã€‚

## headers å±æ€§

- åœ¨ request å¯¹è±¡çš„ header ä¸­ä¹ŸåŒ…å«å¾ˆå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¼šé»˜è®¤ä¼ é€’è¿‡æ¥ä¸€äº›ä¿¡æ¯
- content-type æ˜¯è¿™æ¬¡è¯·æ±‚æºå¸¦çš„æ•°æ®çš„ç±»å‹
  - application/json è¡¨ç¤ºæ˜¯ä¸€ä¸ª json ç±»å‹
  - text/plain è¡¨ç¤ºæ˜¯æ–‡æœ¬ç±»å‹
  - application/xml è¡¨ç¤º xml ç±»å‹
  - multipart/form-data è¡¨ç¤ºæ˜¯ä¸Šä¼ æ–‡ä»¶
- content-lengthï¼šæ–‡ä»¶çš„å¤§å°å’Œé•¿åº¦
- keep-alive
  - http æ˜¯åŸºäº TCP åè®®çš„ï¼Œä½†æ˜¯é€šå¸¸è¿›è¡Œä¸€æ¬¡è¯·æ±‚å’Œå“åº”ç»“æŸåä¼šç«‹åˆ»ç»ˆç«¯
  - åœ¨ http 1.0 ä¸­ï¼Œå¦‚æœæƒ³è¦ç»§ç»­ä¿æŒè¿æ¥
    - æµè§ˆå™¨éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  connection: keep-alive
    - æœåŠ¡å™¨éœ€è¦åœ¨å“åº”å¤´ä¸­æ·»åŠ  connection: keep-alive
    - å½“å®¢æˆ·ç«¯å†æ¬¡æ”¾è¯·æ±‚æ—¶ï¼Œå°±ä¼šä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ï¼Œç›´æ¥ä¸€æ–¹ä¸­æ–­è¿æ¥
  - åœ¨ http 1.1 ä¸­ï¼Œæ‰€æœ‰è¿æ¥é»˜è®¤æ˜¯ connection: keep-alive çš„
    - ä¸åŒçš„ web æœåŠ¡å™¨ä¼šæœ‰ä¸åŒçš„ä¿æŒ keep-alive çš„æ—¶é—´
    - node ä¸­é»˜è®¤æ˜¯ 5 s çš„
- accept-encodingï¼šå‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯æ”¯æŒçš„æ–‡ä»¶å‹ç¼©æ ¼å¼ï¼Œæ¯”å¦‚ js æ–‡ä»¶å¯ä»¥ä½¿ç”¨ gzip ç¼–ç ï¼Œå¯¹åº”. gz æ–‡ä»¶
- acdept: å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å¯æ¥å—æ–‡ä»¶çš„æ ¼å¼ç±»å‹
- user-agentï¼šå®¢æˆ·ç«¯ç›¸å…³çš„ä¿¡æ¯

## è¿”å›å“åº”æ•°æ®

- å¦‚æœæˆ‘ä»¬å¸Œæœ›ç»™å®¢æˆ·ç«¯å“åº”çš„ç»“æœæ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼
  - write æ–¹æ³•ï¼šè¿™ç§æ–¹å¼æˆç›´æ¥å†™å‡ºæ•°æ®ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å…³é—­æµ
  - end æ–¹æ³•ï¼šè¿™ç§æ–¹å¼æ˜¯å†™å‡ºæœ€åçš„æ•°æ®ï¼Œå¹¶ä¸”å†™å‡ºåä¼šå…³é—­æµ

```js
//å“åº”æ•°æ®çš„æ–¹å¼æœ‰ä¸¤ç§
res.write('hello world')
res.write('hello response')
res.end('message end')
```

- å¦‚æœæˆ‘ä»¬æ²¡æœ‰è°ƒç”¨ end å’Œ closeï¼Œå®¢æˆ·ç«¯å°†ä¼šä¸€ç›´ç­‰å¾…ç»“æœ
  - æ‰€ä»¥å®¢æˆ·ç«¯åœ¨å‘é€ç½‘ç»œè¯·æ±‚æ—¶ï¼Œéƒ½ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´

### è¿”å›çŠ¶æ€ç 

- http çŠ¶æ€ç ï¼ˆhttp status codeï¼‰æ˜¯ç”¨æ¥è¡¨ç¤º http å“åº”çŠ¶æ€çš„æ•°å­—ä»£ç 
  - http çŠ¶æ€ç éå¸¸å¤šï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„æƒ…å†µï¼Œç»™å®¢æˆ·ç«¯è¿”å›ä¸åŒçš„çŠ¶æ€ç 
  - åˆ›å»ºçš„çŠ¶æ€ç æ˜¯ä¸‹é¢è¿™äº›ï¼ˆåç»­é¡¹ç›®ä¸­ï¼Œä¹Ÿä¼šç”¨åˆ°å…¶ä¸­çš„çŠ¶æ€ç ï¼‰
- è®¾ç½®çŠ¶æ€ç åˆ›å»ºçš„æœ‰ä¸¤ç§æ–¹å¼ï¼š

```js
res.statusCode = 400
res.writeHead(200)
```

### å“åº”å¤´æ–‡ä»¶

- è¿”å›å¤´éƒ¨ä¿¡æ¯ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š
  - res. setHeader: ä¸€æ¬¡å†™å…¥ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯
  - res. writeHead: åŒæ—¶å†™å…¥ header å’Œ status

```js
res.setHeader('Content-Type', 'application/json;charset=utf8')
res.writeHead(200, {
  'Content-Type': 'application/json;charset=utf8'
})
```

- Header è®¾ç½® Content-Type æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ- é»˜è®¤å®¢æˆ·ç«¯æ”¶åˆ°çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå®¢æˆ·ç«¯ä¼šæŒ‰ç…§è‡ªå·±é»˜è®¤çš„æ–¹å¼è¿›è¡Œå¤„ç†
  ![](https://s2.loli.net/2023/10/15/v3WbnMOmNR9Fs7Z.png)

### http è¯·æ±‚

- axios åº“å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨ node ä¸­ä½¿ç”¨ï¼š
  - åœ¨æµè§ˆå™¨ä¸­ï¼Œaxios ä½¿ç”¨çš„æ˜¯å°è£…çš„ xhr
  - åœ¨ node ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ http å†…ç½®æ¨¡å—

## æ–‡ä»¶ä¸Šä¼ 

ä½¿ç”¨ http æ¨¡å—æ¥å®ç°çš„æ–‡ä»¶ä¸Šä¼ ä¼šéå¸¸çš„éº»çƒ¦ï¼Œä»¥ä¸‹å±•ç¤ºä¸€ä¸‹ï¼š

### é”™è¯¯çš„åšæ³•

1. å› ä¸ºæ–‡ä»¶ä¸Šä¼ çš„ç±»å‹ä¸º fomData å±äº body æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ req. on æ¥ç›‘å¬è¡¨å•æ•°æ®çš„ä¼ è¾“ï¼Œå¦‚æœæ•°æ®è¶…è¿‡ 64 KB çš„è¯è¿˜ä¼šåˆ†ä¸ºå¤šæ¬¡æ¥è¿›è¡Œä¼ å…¥ï¼Œå…·ä½“å®ç°å°±æ˜¯å¤šæ¬¡å‡ºå‘ req. on
2. åˆ›å»ºå†™å…¥çš„æµã€‚æ¯æ¬¡è¯»å–åˆ°æ•°æ®çš„æ—¶å€™ä½¿ç”¨åˆ›å»ºçš„å†™å…¥æµå†™å…¥æ•°æ®ï¼Œåœ¨ req. on ç›‘å¬çš„ end äº‹ä»¶ä¸­å…³é—­æµã€‚
3. è¿™æ ·åšæ˜¯é”™è¯¯çš„åšæ³•ï¼Œå› ä¸ºæˆ‘ä»¬è·å–åˆ°çš„ body çš„ formData æ•°æ®ä¼šæœ‰åˆ«çš„æ•°æ®ï¼Œæ¯”å¦‚ name: dylan, photo: å›¾ç‰‡ï¼Œæˆ‘ä»¬åªéœ€è¦å›¾ç‰‡ï¼Œè€Œå†™å…¥æµä¼šæŠŠ key ä¹Ÿå°±æ˜¯ name å’Œ phoneï¼Œè¿˜æœ‰å¤šä½™çš„ value: dylan ä¹Ÿå†™å…¥åˆ°æµçš„æ•°æ®ä¸­ï¼Œæ‰€æœ‰æœ€åæˆ‘ä»¬çš„åˆ°çš„æ•°æ®æ˜¯ä¸€ä¸ªå¤§æ‚çƒ©ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå›¾ç‰‡ï¼Œæ‰€ä»¥å°±ç®—æˆ‘ä»¬å†™å…¥å®Œåå‘½åä¸º png ä¹Ÿæ‰“ä¸å¼€ã€‚

```js
const http = require('http')
const fs = require('fs')

const server = http.createServer((req, res) => {
  if (req.url === '/upload') {
    // åˆ›å»ºå†™å…¥çš„æµ writableçš„stream
    const writeStream = fs.createWriteStream('./foo.png', {
      flags: 'a+'
    })
    // ä¹Ÿå¯ä»¥ä¸æ˜¯ç”¨writeStream.writeå’ŒwriteSream.closeä¸¤ä¸ªæ–¹æ³•
    // req.pipe(writeStream)
    // å®¢æˆ·ç«¯ä¼ é€’çš„æ•°æ®æ˜¯è¡¨å•æ•°æ®ï¼ˆè¯·æ±‚ä½“ï¼‰
    req.on('data', data => {
      console.log('ğŸš€ ~ file: update.js:6 ~ server ~ data:', data)
      // è¿™æ ·è§£æå›¾ç‰‡æ–‡ä»¶æ˜¯é”™è¯¯çš„ ä¼šæŠŠkeyå’Œvalueï¼ˆä¹Ÿå°±æ˜¯å›¾ç‰‡ï¼‰æ··åœ¨ä¸€èµ·ï¼Œç„¶åå›¾ç‰‡è§£æä¸å‡ºæ¥
      // éœ€è¦æŠ›å‡ºæ²¡ç”¨çš„æ•°æ®ä¹Ÿå°±æ˜¯keyï¼Œç„¶åä¿å­˜å›¾ç‰‡æ–‡ä»¶
      writeStream.write(data)
    })

    req.on('end', () => {
      writeStream.close()
      res.end('æ–‡ä»¶ä¸Šä¼ æˆåŠŸäº†')
    })
  }
})

server.listen(8000, () => {
  console.log(`æœåŠ¡å™¨å¼€å¯æˆåŠŸäº†`)
})
```

### æ­£ç¡®çš„åšæ³•

1.  ä½¿ç”¨äºŒè¿›åˆ¶å¯¹å‰ç«¯ä¼ è¿‡æ¥çš„æ•°æ®è¿›è¡Œç¼–ç 
2.  è¿™æ¬¡æˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨è¯»å…¥æµæ¥è¯»å–æ•°æ®ï¼Œè€Œæ˜¯å®šä¹‰ä¸€ä¸ª formData å­—æ®µæ¥å­˜å‚¨æ‰€æœ‰çš„ä¼ è¿‡æ¥çš„æ•°æ®ã€‚
3.  å½“æ‰€æœ‰çš„æ•°æ®è·å–å®Œæ¯•åæˆ‘ä»¬å¯¹æ•°æ®è¿›è¡Œæˆªå–ï¼Œå»é™¤æ‰å¤šä½™çš„æ•°æ®ï¼Œåªç•™ä¸‹å›¾ç‰‡çš„æ•°æ®ç„¶åä¿å­˜ä¸‹æ¥å³å¯ã€‚

apifox ä¸Šä¼ çš„æ•°æ®ï¼š

![](https://s2.loli.net/2023/10/17/TBQo6xbR3CzFyI5.png)

![](https://s2.loli.net/2023/10/17/HzFLMXDnW4I51p3.png)

çº¢æ¨ªçº¿ä¸‹é¢çš„ä¸ºå›¾ç‰‡çš„æ•°æ®ï¼Œä¸Šé¢çš„ä¸ºå¤šä½™çš„æ•°æ®ï¼Œéœ€è¦åˆ é™¤æ‰

![](https://s2.loli.net/2023/10/17/t5uYCPoZ89q3cKR.png)

çº¢æ¨ªçº¿ä¸‹é¢çš„ä¸ºå¤šä½™çš„ boundary æ•°æ®ä¹Ÿéœ€è¦åˆ é™¤æ‰

```js
const http = require('http')
const fs = require('fs')

const server = http.createServer((req, res) => {
  //äºŒè¿›åˆ¶ç¼–ç 
  req.setEncoding('binary')

  //å›¾ç‰‡æœ€åé¢çš„ä¸€äº›æ•°æ®
  const boundary = req.headers['content-type'].split('; ')[1].replace('boundary=', '')

  let formData = ''
  req.on('data', data => {
    console.log('ğŸš€ ~ file: upload1.js:7 ~ req.on ~ data:', data)
    formData += data
  })

  req.on('end', () => {
    console.log(formData)
    //1. æˆªå–ä»image/jpegä½ç½®å¼€å§‹åé¢çš„æ‰€æœ‰çš„æ•°æ®

    let imgType = 'image/jpeg'
    let imageTypePosition = formData.indexOf(imgType) + imgType.length
    let imageData = formData.substring(imageTypePosition)

    //2. imageDataå¼€å§‹ä½ç½®æœ‰ä¸¤ä¸ªç©ºæ ¼
    imageData = imageData.replace(/^\s\s*/, '')

    //3. æ›¿æ¢æœ€åçš„boundary
    imageData = imageData.substring(0, imageData.indexOf(`--${boundary}--`))

    //4. å°†imageDataçš„æ•°æ®å­˜å‚¨æ–‡ä»¶ä¸­
    fs.writeFile('./bar.png', imageData, 'binary', () => {
      console.log('æ–‡ä»¶å­˜å‚¨æˆåŠŸ')
      res.end(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸäº†`)
    })
  })
})

server.listen(8000, () => {
  console.log(`æœåŠ¡å™¨å¯åŠ¨äº†`)
})
```

### æµè§ˆå™¨ä¸Šä¼ 

ä»¥ä¸Šçš„æ•°æ®éƒ½æ˜¯ä½¿ç”¨ apifox æ¥å®Œæˆçš„ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨ä»£ç æ¥å®ç°ä»¥ä¸‹æ–‡ä»¶ä¸Šä¼ ï¼š

```js
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Document</title>
  </head>
  <body>
    <input type="file" />
    <button>ä¸Šä¼ </button>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      //æ–‡ä»¶ä¸Šä¼ çš„é€»è¾‘
      const btnEl = document.querySelector('button')
      btnEl.onclick = function () {
        //1. åˆ›å»ºè¡¨å•å¯¹è±¡
        const formData = new FormData()
        //2. å°†é€‰ä¸­çš„å›¾æ ‡æ–‡ä»¶æ”¾å…¥è¡¨å•
        const inputEl = document.querySelector('input')
        formData.set('phone', inputEl.files[0])

        //3. å‘é€postè¯·æ±‚ï¼Œå°†è¡¨å•æ•°æ®æºå¸¦åˆ°æœåŠ¡å™¨
        axios({
          method: 'post',
          url: 'http://localhost:8000',
          data: formData,
          headers: {
            'Content-Type': 'multipart/form-data',
          },
        })
      }
    </script>
  </body>
</html>
```
